@model Wiki.Models.RKD_AllView
@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_LayoutRKD.cshtml";
}
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Index</title>
    <style>
        .container {
            max-width: none !important;
            width: 1500px;
        }

        .form-control {
            max-width: none !important;
            width: 1500px;
        }
    </style>
</head>
<body>
    <div class="row">
        <div class="col-sm-1"></div>
        <div class="col-sm-10">

            @using (Html.BeginForm())
            {
                <table>
                    @if (@ViewBag.PredcwssorOrderLink > 0)
                    {
                        <tr style="vertical-align: top;">
                            @try
                            {
                                @Html.ActionLink("Предыдущий заказ", "OpenOrder", "RKD", new { idOrder = @ViewBag.PredcwssorOrderLink }, null)
                            }
                            catch
                            {

                            }
                        </tr>
                    }
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    @if (@ViewBag.PoslOrderLink > 0)
                    {
                        <tr style="vertical-align: top;">
                            @try
                            {
                                @Html.ActionLink("Следующий заказ", "OpenOrder", "RKD", new { idOrder = @ViewBag.PoslOrderLink }, null)
                            }
                            catch
                            {

                            }
                        </tr>
                    }
                </table>
                <h4>Требуется получить информацию от Заказчика</h4>
                <h4>№ заказа: @ViewBag.PlanZakaz</h4>
                <h5>Заказчик: @ViewBag.Client</h5>
                <h5>Проектный институт: @ViewBag.Inst</h5>
                @Html.ActionLink("Изменить проектный институт", "EditInst", "RKD", new { id = ViewBag.idOrder }, new { @class = "viewDialog", data_dialog_title = "Выберете проектный институт" })
                <h5>Наименование заказа (контрактное): @ViewBag.PlanZakazName</h5>
                <hr />
                @Html.AntiForgeryToken()
                @Html.ActionLink("Получены замечания", "GetErrorList", new { idOrder = @ViewBag.idOrder }, new { @class = "btn btn-danger" })
                <nobr> &nbsp;		 </nobr>
                @Html.ActionLink("Получено согласование", "GetGoodList", new { idOrder = @ViewBag.idOrder }, new { @class = "btn btn-primary" })
                <nobr> &nbsp;		 </nobr>
                @Html.ActionLink("Требуется доп. время", "PlusClientDay", new { idOrder = @ViewBag.idOrder }, new { @class = "btn btn-info" })
                if (ViewBag.ActiveQuestion != null)
                {
                    <hr />
                    <h4> Активные вопросы </h4>
                    <table class="table table-hover" style="width:1000px">
                        <thead>
                            <tr>
                                <th> Вопрос/ответ </th>
                                <th> № вопроса </th>
                                <th> № заказа </th>
                                <th> Вопрос </th>
                                <th> Ход обсуждения </th>
                                <th data-sortable="true"> Дата/время создания </th>
                                <th> Сотрудник создавший вопрос </th>
                            </tr>
                        </thead>
                        <tbody id="myTable">
                            @foreach (var item in ViewBag.ActiveQuestion)
                            {
                                <tr>
                                    <td> @Html.ActionLink("Вопрос/ответ", "UpdateQuestion", "RKD", new { id = item.id }, null) </td>
                                    <td> @item.id </td>
                                    <td> @item.RKD_Order.PZ_PlanZakaz.PlanZakaz </td>
                                    <td> @item.textQuestion </td>
                                    <td>
                                        @try
                                        {
                                            foreach (var item2 in item.RKD_QuestionData)
                                            {
                                                @item2.AspNetUsers.CiliricalName <nobr>: </nobr> @item2.textData <br />
                                            }
                                        }
                                        catch
                                        {
                                            <p></p>
                                        }
                                    </td>
                                    <td> @item.dateUpload </td>
                                    <td> @item.AspNetUsers.CiliricalName </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <hr />
                }
                <hr />
                <table class="table table-hover" style="width:1000px">
                    <thead style="background-color:black;">
                        <tr class="something" style="color: white;">
                            <th class="col-md-2">Задача</th>
                            @foreach (var item in Model.ActiveOrder.GroupBy(d => d.id_RKD_Version).ToList())
                            {
                                <th class="col-md-1"><nobr>V.</nobr>@item.First().RKD_Version.numberVersion1.ToString()<nobr>.</nobr>@item.First().RKD_Version.numberVersion2.ToString()</th>
                            }
                        </tr>
                        <tr class="warning">
                            <th class="col-md-2">Дата передачи РКД в ТП</th>
                            @foreach (var item in Model.ActiveOrder.GroupBy(d => d.id_RKD_Version).ToList())
                            {
                                <th class="col-md-1">
                                    @try
                                    {
                                        @item.First().RKD_Version.RKD_Mail_Version.Where(d => d.id_TypeRKD_Mail_Version == 1).Max(d => d.dateTimeUpload).ToString().Substring(0, 10)
                                    }
                                    catch
                                    {

                                    }
                                </th>
                            }
                        </tr>
                        <tr class="warning">
                            <th class="col-md-2">Дата отправки РКД Заказчику</th>
                            @foreach (var item in Model.ActiveOrder.GroupBy(d => d.id_RKD_Version).ToList())
                            {
                                <th class="col-md-1">
                                    @try
                                    {
                                        @item.First().RKD_Version.RKD_Mail_Version.Where(d => d.id_TypeRKD_Mail_Version == 4).Max(d => d.dateTimeUpload).ToString().Substring(0, 10)
                                    }
                                    catch
                                    {

                                    }
                                </th>
                            }
                        </tr>
                        <tr class="warning">
                            <th class="col-md-2">Дата получения ответа</th>
                            @foreach (var item in Model.ActiveOrder.GroupBy(d => d.id_RKD_Version).ToList())
                            {
                                <th class="col-md-1">
                                    @try
                                    {
                                        @item.First().RKD_Version.RKD_Mail_Version.Where(d => d.id_TypeRKD_Mail_Version == 7).Max(d => d.dateTimeUpload).ToString().Substring(0, 10)
                                    }
                                    catch
                                    {

                                    }
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody id="myTable">
                        @foreach (var item2 in Model.ActiveOrder.GroupBy(d => d.id_RKD_Task).ToList())
                        {
                            <tr>
                                <td>@item2.First().RKD_Task.RKD_TypeTask.name</td>
                                @foreach (var item5 in item2.ToList())
                                {
                                    if (item5.id_RKD_Task == item2.First().id_RKD_Task)
                                    {
                                        if (item5.RKD_Version.activeVersion == true)
                                        {
                                            if (@item5.allComplited == true)
                                            {
                                                <td class="success">@Html.ActionLink(@item5.finishDate.ToString().Substring(0, 10), "EditTask", "RKD", new { idTask = item5.id }, new { @class = "viewDialog", @style = "color:black;", data_dialog_title = "Разрешить выполнение работ" })</td>
                                            }
                                            else if (@item5.manufComplited == true)
                                            {
                                                <td class="active">@Html.ActionLink(@item5.finishDate.ToString().Substring(0, 10) + " / ПО ", "EditTask", "RKD", new { idTask = item5.id }, new { @class = "viewDialog", @style = "color:black;", data_dialog_title = "Разрешить выполнение работ" })</td>
                                            }
                                            else if (@item5.osComplited == true)
                                            {
                                                <td class="info">@Html.ActionLink(@item5.finishDate.ToString().Substring(0, 10) + " / ОС ", "EditTask", "RKD", new { idTask = item5.id }, new { @class = "viewDialog", @style = "color:black;", data_dialog_title = "Разрешить выполнение работ" })</td>
                                            }
                                            else if (@item5.uslovnoeComplited == true)
                                            {
                                                <td class="warning">@Html.ActionLink(@item5.finishDate.ToString().Substring(0, 10) + " / КО ", "EditTask", "RKD", new { idTask = item5.id }, new { @class = "viewDialog", @style = "color:black;", data_dialog_title = "Разрешить выполнение работ" })</td>
                                            }
                                            else
                                            {
                                                <td class="danger">@Html.ActionLink(@item5.finishDate.ToString().Substring(0, 10), "EditTask", "RKD", new { idTask = item5.id }, new { @class = "viewDialog", @style = "color:black;", data_dialog_title = "Разрешить выполнение работ" })</td>
                                            }
                                        }
                                        else
                                        {
                                            if (@item5.allComplited == true)
                                            {
                                                <td class="success">@item5.finishDate.ToString().Substring(0, 10)</td>
                                            }
                                            else if (@item5.manufComplited == true)
                                            {
                                                <td class="active">@item5.finishDate.ToString().Substring(0, 10)   / ПО </td>
                                            }
                                            else if (@item5.osComplited == true)
                                            {
                                                <td class="info">@item5.finishDate.ToString().Substring(0, 10)  / ОС </td>
                                            }
                                            else if (@item5.uslovnoeComplited == true)
                                            {
                                                <td class="warning">@item5.finishDate.ToString().Substring(0, 10)   / КО </td>
                                            }
                                            else
                                            {
                                                <td class="danger">@item5.finishDate.ToString().Substring(0, 10)</td>
                                            }
                                        }
                                    }

                                }
                            </tr>
                        }
                    </tbody>
                </table>
                <hr />
                @Html.ActionLink("Назад", "Index", null, new { @class = "btn btn-danger" })
                <br />
                <br />
                @Html.ActionLink("Добавить запись", "CreateNewDespatching", "RKD", new { idOrder = ViewBag.idOrder }, new { @class = "viewDialog", data_dialog_title = "Внесите данные обсуждения" })
                <table class="table table-hover" style="width:1500px">
                    <thead>
                        <tr>
                            <th> Дата </th>
                            <th> Описание </th>
                            <th> ФИО </th>
                            <th> Срок </th>
                        </tr>
                    </thead>
                    <tbody id="myTable">
                        @foreach (var item in ViewBag.Despatching)
                        {

                            if (item.TypeTask == 0)
                            {
                                <tr>
                                    <td> @item.DateEvent.ToString().Substring(0, 16) </td>
                                    <td> @item.TextData </td>
                                    <td> @item.UserID </td>
                                    <td> @item.TaskFinishDate </td>
                                </tr>
                            }
                            else if (item.TypeTask == 100)
                            {
                                <tr>
                                    <td class="warning"> @item.DateEvent.ToString().Substring(0, 16) </td>
                                    <td class="warning"> @item.TextData </td>
                                    <td class="warning"> @item.UserID </td>
                                    <td class="warning"> @item.TaskFinishDate </td>
                                </tr>
                            }
                            else
                            {
                                <tr>
                                    <td class="active"> @item.DateEvent.ToString().Substring(0, 16) </td>
                                    <td class="active"> @item.TextData </td>
                                    <td class="active"> @item.UserID </td>
                                    <td class="active"> @item.TaskFinishDate </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
                <hr />
                if (ViewBag.CloseQuestion != null)
                {
                    <h4>Закрытые вопросы</h4>
                    <table class="table table-hover" style="width:1000px">
                        <thead>
                            <tr>
                                <th> № вопроса </th>
                                <th> № заказа </th>
                                <th> Вопрос </th>
                                <th> Ход обсуждения </th>
                                <th data-sortable="true"> Дата/время создания </th>
                                <th> Сотрудник создавший вопрос </th>
                            </tr>
                        </thead>
                        <tbody id="myTable">
                            @foreach (var item in ViewBag.CloseQuestion)
                            {
                                <tr>
                                    <td> @item.id </td>
                                    <td> @item.RKD_Order.PZ_PlanZakaz.PlanZakaz </td>
                                    <td> @item.textQuestion </td>
                                    <td>
                                        @try
                                        {
                                            foreach (var item2 in item.RKD_QuestionData)
                                            {
                                                @item2.AspNetUsers.CiliricalName <nobr>: </nobr> @item2.textData <br />
                                            }
                                        }
                                        catch
                                        {
                                            <p></p>
                                        }
                                    </td>
                                    <td> @item.dateUpload </td>
                                    <td> @item.AspNetUsers.CiliricalName </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <hr />
                }
                <script src='@Url.Content("~/Scripts/jquery-3.1.1.min.js")' type="text/javascript"></script>
                <script src='@Url.Content("~/Scripts/jquery-ui-1.12.1.min.js")' type="text/javascript"></script>
                <script>
                    $(document).ready(function () {
                        $.ajaxSetup({ cache: false });
                        $(".viewDialog").on("click", function (e) {
                            e.preventDefault();
                            $("<div></div>")
                                .addClass("dialog")
                                .appendTo("body")
                                .dialog({
                                    title: $(this).attr("data-dialog-title"),
                                    close: function () { $(this).remove() },
                                    width: 1000,
                                    height: 550,
                                    modal: true
                                })
                                .load(this.href);
                        });
                    });
                </script>
            }
            <hr />
        </div>
        <div class="col-sm-1"></div>
    </div>
</body>
</html>